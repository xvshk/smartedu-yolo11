# 系统架构图（分层结构）

## 基于YOLO11课堂行为感知与精准预警系统架构图

```mermaid
flowchart TB
    subgraph 表现层
        A1[表现层]
    end
    
    subgraph 表现层组件
        B1[Vue3前端应用]
    end
    
    subgraph 业务逻辑层
        A2[业务逻辑层]
    end
    
    subgraph 业务逻辑层组件
        C1[JWT认证管理]
        C2[核心服务整合]
    end
    
    subgraph 服务层
        A3[服务层]
    end
    
    subgraph 服务层组件
        D1[检测服务]
        D2[预警服务]
        D3[画像服务]
        D4[通知服务]
        D5[规则引擎]
    end
    
    subgraph 模型层
        A4[模型层]
    end
    
    subgraph 模型层组件
        E1[模型推理]
        E2[YOLO11检测<br/>模型训练]
        E3[MLflow模型<br/>管理]
    end
    
    subgraph 数据层
        A5[数据层]
    end
    
    subgraph 数据层组件
        F1[MySQL数据<br/>库操作]
        F2[数据预处<br/>理]
        F3[行为标注<br/>生成]
    end
    
    A1 --> A2
    A2 --> A3
    A3 --> A4
    A4 --> A5
    
    B1 --> C1
    B1 --> C2
    C1 --> D1
    C1 --> D2
    C2 --> D3
    C2 --> D4
    C2 --> D5
    D1 --> E1
    D2 --> E2
    D5 --> E3
    E1 --> F1
    E2 --> F2
    E3 --> F3
```

---

## 简化版架构图

```mermaid
flowchart TB
    subgraph L1[表现层]
        P1[Vue3前端应用<br/>Element Plus + ECharts]
    end
    
    subgraph L2[业务逻辑层]
        B1[JWT认证管理]
        B2[核心服务整合]
    end
    
    subgraph L3[服务层]
        S1[检测服务]
        S2[预警服务]
        S3[画像服务]
        S4[通知服务]
        S5[规则引擎]
    end
    
    subgraph L4[模型层]
        M1[模型推理]
        M2[YOLO11检测<br/>模型训练]
        M3[MLflow模型<br/>管理]
    end
    
    subgraph L5[数据层]
        D1[MySQL数据<br/>库操作]
        D2[数据预处理]
        D3[行为标注<br/>生成]
    end
    
    L1 --> L2
    L2 --> L3
    L3 --> L4
    L4 --> L5
    
    P1 --> B1 & B2
    B1 & B2 --> S1 & S2 & S3 & S4 & S5
    S1 & S2 & S3 & S4 & S5 --> M1 & M2 & M3
    M1 & M2 & M3 --> D1 & D2 & D3
```

---

## 目录结构与分层对应

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              分层架构与目录映射                                   │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┬───────────────────────────────────────────────────────────────┐
│     分层        │                        目录/文件                               │
├─────────────────┼───────────────────────────────────────────────────────────────┤
│   表现层        │  frontend/src/views/                                          │
│                 │  frontend/src/components/                                     │
│                 │  frontend/src/stores/                                         │
├─────────────────┼───────────────────────────────────────────────────────────────┤
│   业务逻辑层    │  backend/api/                                                 │
│                 │  backend/app.py                                               │
├─────────────────┼───────────────────────────────────────────────────────────────┤
│   服务层        │  backend/services/                                            │
│                 │    ├── detection_service.py                                   │
│                 │    ├── alert_service.py                                       │
│                 │    ├── portrait_service.py                                    │
│                 │    ├── notification_service.py                                │
│                 │    ├── rule_engine.py                                         │
│                 │    └── intervention_service.py                                │
├─────────────────┼───────────────────────────────────────────────────────────────┤
│   模型层        │  backend/ml/mlflow_tracker.py                                 │
│                 │  src/core/training/training_pipeline.py                       │
│                 │  src/scripts/train.py                                         │
│                 │  src/scripts/train_optimized_4050.py                          │
├─────────────────┼───────────────────────────────────────────────────────────────┤
│   数据层        │  src/core/database/                                           │
│                 │    ├── repositories/ (8个数据仓库)                            │
│                 │    ├── manager.py                                             │
│                 │    └── config.py                                              │
│                 │  src/core/data/                                               │
│                 │    ├── data_merger.py                                         │
│                 │    └── label_mapper.py                                        │
├─────────────────┼───────────────────────────────────────────────────────────────┤
│   工具层        │  src/utils/                                                   │
│                 │    ├── data_validation_utils.py (业务层)                      │
│                 │    └── data_validation/ (三层架构)                            │
│                 │        ├── constants.py                                       │
│                 │        ├── validators.py                                      │
│                 │        ├── analyzers.py                                       │
│                 │        ├── visualizers.py                                     │
│                 │        ├── reporters.py                                       │
│                 │        └── cleaners.py                                        │
└─────────────────┴───────────────────────────────────────────────────────────────┘
```

---

## 三层架构详解：src/utils/data_validation/

```mermaid
flowchart TB
    subgraph 业务层["业务层 (Business Layer)"]
        BL1[data_validation_utils.py<br/>统一对外接口]
    end
    
    subgraph 服务层["服务层 (Service Layer)"]
        SL1[validators.py<br/>数据验证]
        SL2[analyzers.py<br/>数据分析]
        SL3[visualizers.py<br/>可视化]
        SL4[reporters.py<br/>报告生成]
        SL5[cleaners.py<br/>数据清洗]
    end
    
    subgraph 基础层["基础层 (Foundation Layer)"]
        FL1[constants.py<br/>常量定义]
    end
    
    BL1 --> SL1 & SL2 & SL3 & SL4 & SL5
    SL1 & SL2 & SL3 & SL4 & SL5 --> FL1
```

### 各模块职责

| 模块 | 职责 | 主要功能 |
|------|------|----------|
| constants.py | 常量定义 | 行为类别、颜色映射、阈值配置 |
| validators.py | 数据验证 | 标签格式验证、边界框验证 |
| analyzers.py | 数据分析 | 类别分布、数据集统计 |
| visualizers.py | 可视化 | 分布图、混淆矩阵、样本展示 |
| reporters.py | 报告生成 | HTML/Markdown报告 |
| cleaners.py | 数据清洗 | 异常数据修复、格式标准化 |
| data_validation_utils.py | 业务入口 | 统一调用接口 |

---

## src/ 目录结构

```
src/                            # 源代码模块
├── core/                       # 核心业务逻辑
│   ├── config/                 # 行为配置
│   │   └── behavior_config.py
│   ├── data/                   # 数据预处理
│   │   ├── data_merger.py
│   │   └── label_mapper.py
│   ├── training/               # 模型训练
│   │   └── training_pipeline.py
│   └── database/               # 数据库访问层
│       ├── config.py
│       ├── manager.py
│       ├── repositories/       # 数据仓库 (8个)
│       └── services/
├── scripts/                    # CLI脚本入口
│   ├── yolo_validate.py        # 模型验证
│   ├── train.py                # 模型训练
│   └── train_optimized_4050.py # RTX 4050优化训练
└── utils/                      # 工具模块
    ├── data_validation_utils.py  # 业务层服务
    └── data_validation/          # 三层架构
        ├── constants.py
        ├── validators.py
        ├── analyzers.py
        ├── visualizers.py
        ├── reporters.py
        └── cleaners.py
```
